[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
loglevel=info

[inet_http_server]
port=127.0.0.1:9001

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=http://127.0.0.1:9001

; Registry runs as a permanent background service
[program:registry]
command=/usr/local/bin/registry serve /etc/registry/config.yml
autostart=true
autorestart=true
stdout_logfile=/var/log/registry.log
stderr_logfile=/var/log/registry-err.log
environment=REGISTRY_STORAGE_DELETE_ENABLED="true"

; Trivy DB update runs periodically via a cron-like wrapper
; Trivy itself is stateless â€” no daemon needed
[program:trivy-db-updater]
command=/bin/bash -c 'while true; do trivy image --download-db-only --cache-dir /var/cache/trivy; sleep 21600; done'
autostart=true
autorestart=true
stdout_logfile=/var/log/trivy-update.log
stderr_logfile=/var/log/trivy-update-err.log

; Portalcrane FastAPI backend
[program:portalcrane]
command=uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2
autostart=true
autorestart=true
stdout_logfile=/var/log/portalcrane.log
stderr_logfile=/var/log/portalcrane-err.log