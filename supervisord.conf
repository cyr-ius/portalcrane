[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
loglevel=info

[inet_http_server]
port=127.0.0.1:9001

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=http://127.0.0.1:9001

; Registry runs as a permanent background service
[program:registry]
command=/usr/local/bin/registry serve /etc/registry/config.yml
autostart=true
autorestart=true
stdout_logfile=/var/log/registry.log
stderr_logfile=/var/log/registry-err.log
environment=REGISTRY_STORAGE_DELETE_ENABLED="true"

; Trivy server — runs as a persistent HTTP API on localhost:4954
; The DB is downloaded at first start (--skip-db-update=false by default)
; then periodically refreshed by trivy-db-updater
[program:trivy-server]
command=/usr/local/bin/trivy server
    --listen 127.0.0.1:4954
    --cache-dir /var/cache/trivy
autostart=true
autorestart=true
stdout_logfile=/var/log/trivy-server.log
stderr_logfile=/var/log/trivy-server-err.log

; Periodic Trivy DB refresh — every 6 h (DB is already populated by trivy-server at startup)
[program:trivy-db-updater]
command=/bin/bash -c 'sleep 21600; while true; do trivy image --download-db-only --cache-dir /var/cache/trivy; sleep 21600; done'
autostart=true
autorestart=true
stdout_logfile=/var/log/trivy-update.log
stderr_logfile=/var/log/trivy-update-err.log

; Portalcrane FastAPI backend — waits for registry and trivy to be ready
[program:portalcrane]
command=uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2
autostart=true
autorestart=true
stdout_logfile=/var/log/portalcrane.log
stderr_logfile=/var/log/portalcrane-err.log