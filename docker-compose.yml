version: "3.9"

# ─── Portalcrane Development Stack ─────────────────────────────────────────
# Includes: Portalcrane app, Docker Registry
# Usage: docker compose up -d

services:
  # ── Portalcrane Application ──────────────────────────────────────────────
  portalcrane:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: portalcrane
    ports:
      - "8080:8080"
    environment:
      # ── Registry configuration ────────────────────────────────────────────
      - REGISTRY_PROXY_AUTH_ENABLED=${REGISTRY_PROXY_AUTH_ENABLED:-true}

      # ── Admin credentials ─────────────────────────────────────────────────
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}

      # ── JWT ───────────────────────────────────────────────────────────────
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}

      # ── OIDC (optional) ───────────────────────────────────────────────────
      - OIDC_ENABLED=${OIDC_ENABLED:-false}
      - OIDC_ISSUER=${OIDC_ISSUER:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - OIDC_REDIRECT_URI=${OIDC_REDIRECT_URI:-http://localhost:8080/auth/callback}

      # ── Docker Hub (optional, for staging pulls) ──────────────────────────
      - DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME:-}
      - DOCKERHUB_PASSWORD=${DOCKERHUB_PASSWORD:-}

      # ── Vulnerability scanning (Trivy) ────────────────────────────────────
      - VULN_SCAN_ENABLED=${VULN_SCAN_ENABLED:-true}
      - VULN_SCAN_SEVERITIES=${VULN_SCAN_SEVERITIES:-CRITICAL,HIGH}
      - VULN_IGNORE_UNFIXED=${VULN_IGNORE_UNFIXED:-false}
      - VULN_SCAN_TIMEOUT=${VULN_SCAN_TIMEOUT:-5m}

      # ── HTTP Proxy (optional) ─────────────────────────────────────────────
      # - HTTP_PROXY=http://proxy.corp:3128
      # - HTTPS_PROXY=http://proxy.corp:3128
      # - NO_PROXY=localhost,127.0.0.1

      # ── Logging ───────────────────────────────────────────────────────────
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}

    volumes:
      - portalcrane_data:/var/lib/portalcrane
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  portalcrane_data:
