version: "3.9"

# ─── Portalcrane Development Stack ─────────────────────────────────────────
# Includes: Portalcrane app, Docker Registry, ClamAV
# Usage: docker compose up -d

services:
  # ── Portalcrane Application ──────────────────────────────────────────────
  portalcrane:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: portalcrane
    ports:
      - "8080:8080"
    environment:
      # Registry connection
      - REGISTRY_URL=http://registry:5000
      # REGISTRY_PUSH_HOST: the Docker daemon runs on the HOST, not inside the compose network.
      # The registry port 5000 is published on the host, so localhost:5000 always works.
      - REGISTRY_PUSH_HOST=localhost:5000
      - REGISTRY_USERNAME=${REGISTRY_USERNAME:-}
      - REGISTRY_PASSWORD=${REGISTRY_PASSWORD:-}
      # Admin credentials
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}
      # JWT
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      # OIDC (optional)
      - OIDC_ENABLED=${OIDC_ENABLED:-false}
      - OIDC_ISSUER=${OIDC_ISSUER:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - OIDC_REDIRECT_URI=${OIDC_REDIRECT_URI:-http://localhost:8080/auth/callback}
      # Docker Hub (optional)
      - DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME:-}
      - DOCKERHUB_PASSWORD=${DOCKERHUB_PASSWORD:-}
      # Other
      - STAGING_DIR=/tmp/staging
      - ADVANCED_MODE=${ADVANCED_MODE:-false}
      # Vulnerability scan policy (optional, requires trivy in the app image)
      - VULN_SCAN_ENABLED=${VULN_SCAN_ENABLED:-false}
      - VULN_SCAN_SEVERITIES=${VULN_SCAN_SEVERITIES:-CRITICAL,HIGH}
      - VULN_IGNORE_UNFIXED=${VULN_IGNORE_UNFIXED:-false}
      - VULN_SCAN_TIMEOUT=${VULN_SCAN_TIMEOUT:-5m}
      # HTTP Proxy (optional — uncomment if Docker Hub is not directly accessible)
      # Only applies to Portalcrane's own outbound calls (Hub API, docker pull/push).
      # The Docker daemon itself is NOT affected — external pulls remain unchanged.
      # - HTTP_PROXY=http://proxy.corp:3128
      # - HTTPS_PROXY=http://proxy.corp:3128
      # - NO_PROXY=localhost,127.0.0.1,registry
      # - DOCKER_PULL_PROXY=http://proxy.corp:3128
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - staging_data:/tmp/staging
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  staging_data:
