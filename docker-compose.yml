version: "3.9"

# ─── Portalcrane Development Stack ─────────────────────────────────────────
# Includes: Portalcrane app, Docker Registry
# Usage: docker compose up -d

services:
  # ── Portalcrane Application ──────────────────────────────────────────────
  portalcrane:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: portalcrane
    ports:
      - "8080:8080"
      - "5000:5000"
    environment:
      # ── Registry — loopback because registry runs in the same container ───
      # The Portal Crane application uses the host to pull or push images
      # through the Docker socket. It is necessary to expose the container port
      # so that the host can push the images to the registry
      # REGISTRY_PUSH_HOST: the HOST Docker daemon cannot resolve "localhost"
      # inside the container network. Use "127.0.0.1:5000" to push via the
      # published port on the host.
      # - REGISTRY_PUSH_HOST=${REGISTRY_PUSH_HOST:-127.0.0.1:8080}

      # ── Admin credentials ─────────────────────────────────────────────────
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}

      # ── JWT ───────────────────────────────────────────────────────────────
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}

      # ── OIDC (optional) ───────────────────────────────────────────────────
      - OIDC_ENABLED=${OIDC_ENABLED:-false}
      - OIDC_ISSUER=${OIDC_ISSUER:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - OIDC_REDIRECT_URI=${OIDC_REDIRECT_URI:-http://localhost:8080/auth/callback}

      # ── Docker Hub (optional, for staging pulls) ──────────────────────────
      - DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME:-}
      - DOCKERHUB_PASSWORD=${DOCKERHUB_PASSWORD:-}

      # ── Staging ───────────────────────────────────────────────────────────
      - STAGING_DIR=/tmp/staging
      - ADVANCED_MODE=${ADVANCED_MODE:-false}

      # ── Vulnerability scanning (Trivy) ────────────────────────────────────
      - VULN_SCAN_ENABLED=${VULN_SCAN_ENABLED:-true}
      - VULN_SCAN_SEVERITIES=${VULN_SCAN_SEVERITIES:-CRITICAL,HIGH}
      - VULN_IGNORE_UNFIXED=${VULN_IGNORE_UNFIXED:-false}
      - VULN_SCAN_TIMEOUT=${VULN_SCAN_TIMEOUT:-5m}

      # ── HTTP Proxy (optional) ─────────────────────────────────────────────
      # Applies to Portalcrane outbound calls (Docker Hub API, OIDC, docker pull/push).
      # Does NOT affect the Docker daemon itself.
      # - HTTP_PROXY=http://proxy.corp:3128
      # - HTTPS_PROXY=http://proxy.corp:3128
      # - NO_PROXY=localhost,127.0.0.1
      # - DOCKER_PULL_PROXY=http://proxy.corp:3128

      # ── Logging ───────────────────────────────────────────────────────────
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - registry_data:/var/lib/registry
      - staging_data:/tmp/staging
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ── Docker Registry (CNCF Distribution v3) ───────────────────────────────
  # registry:
  #   image: registry:3
  #   container_name: portalcrane-registry
  #   ports:
  #     - "5000:5000"
  #   environment:
  #     - REGISTRY_STORAGE_DELETE_ENABLED=true
  #     - REGISTRY_HTTP_SECRET=${REGISTRY_HTTP_SECRET:-registry-secret}
  #     - OTEL_TRACES_EXPORTER=none
  #     - OTEL_METRICS_EXPORTER=none
  #     - OTEL_LOGS_EXPORTER=none
  #   volumes:
  #     - registry_data:/var/lib/registry
  #   restart: unless-stopped
  #   healthcheck:
  #     test:
  #       [
  #         "CMD",
  #         "wget",
  #         "--quiet",
  #         "--tries=1",
  #         "--spider",
  #         "http://localhost:5000/v2/",
  #       ]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

volumes:
  registry_data:
  staging_data:
