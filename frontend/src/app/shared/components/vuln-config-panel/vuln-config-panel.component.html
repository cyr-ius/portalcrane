<div class="card border-0 mb-3">
  <div
    class="card-header border-0 d-flex align-items-center justify-content-between"
  >
    <h6 class="fw-semibold mb-0">
      <i class="bi bi-shield-exclamation me-2"></i>Vulnerability Scanner (Trivy)
    </h6>
    @if (configService.vulnEnabled()) {
      <span
        class="badge bg-warning-subtle text-warning d-flex align-items-center gap-1"
      >
        <i class="bi bi-pencil-fill" style="font-size: 0.6rem"></i>
        Custom
      </span>
    } @else {
      <span
        class="badge bg-secondary-subtle text-secondary d-flex align-items-center gap-1"
      >
        <i class="bi bi-server" style="font-size: 0.6rem"></i>
        From env
      </span>
    }
  </div>
  <div class="card-body">
    <p class="text-muted small mb-3">
      Scans every pulled image for known vulnerabilities (CVEs) before allowing
      a push to the registry. Requires ClamAV to be enabled as it runs after the
      antivirus step.
    </p>

    <!-- Enable / Disable toggle -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <div class="fw-semibold small">Enable Trivy scan</div>
        <div class="text-muted" style="font-size: 0.75rem">
          Run CVE scan after ClamAV before allowing push
        </div>
      </div>
      <div class="form-check form-switch mb-0">
        <input
          class="form-check-input"
          type="checkbox"
          role="switch"
          id="vulnEnabled"
          [checked]="configService.vulnEnabled()"
          (change)="configService.setVulnEnabled($any($event.target).checked)"
        />
      </div>
    </div>

    @if (configService.vulnEnabled()) {
      <!-- Severities blocking policy -->
      <div class="mb-3">
        <label class="form-label small fw-semibold">
          Blocking severities
          <span class="text-muted fw-normal ms-1">(at least one required)</span>
        </label>
        <div class="d-flex flex-wrap gap-2">
          @for (sev of allSeverities; track sev) {
            <button
              class="btn btn-sm sev-btn"
              [class]="getSevBtnClass(sev)"
              (click)="configService.toggleVulnSeverity(sev)"
              [title]="'Toggle ' + sev"
            >
              {{ sev }}
            </button>
          }
        </div>
        @if (configService.vulnSeverities().length === 0) {
          <div class="text-danger small mt-1">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Select at least one severity
          </div>
        }
      </div>

      <!-- Ignore unfixed -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <div class="fw-semibold small">Ignore unfixed CVEs</div>
          <div class="text-muted" style="font-size: 0.75rem">
            Do not block on CVEs with no available fix
          </div>
        </div>
        <div class="form-check form-switch mb-0">
          <input
            class="form-check-input"
            type="checkbox"
            role="switch"
            id="vulnIgnoreUnfixed"
            [checked]="configService.vulnIgnoreUnfixed()"
            (change)="
              configService.setVulnIgnoreUnfixed($any($event.target).checked)
            "
          />
        </div>
      </div>

      <!-- Timeout -->
      <div class="mb-3">
        <label class="form-label small fw-semibold">Scan timeout</label>
        <div class="d-flex gap-2">
          @for (t of timeoutOptions; track t) {
            <button
              class="btn btn-sm"
              [class.btn-primary]="configService.vulnTimeout() === t"
              [class.btn-outline-secondary]="configService.vulnTimeout() !== t"
              (click)="configService.setVulnTimeout(t)"
            >
              {{ t }}
            </button>
          }
        </div>
      </div>
    }

    <!-- Server defaults comparison -->
    @if (configService.serverConfig(); as cfg) {
      <div class="text-muted mt-2" style="font-size: 0.75rem">
        <i class="bi bi-server me-1"></i>Server default:
        {{ cfg.vuln_scan_enabled ? "enabled" : "disabled" }} — Severities:
        {{ cfg.vuln_scan_severities }} — Ignore unfixed:
        {{ cfg.vuln_ignore_unfixed ? "yes" : "no" }} — Timeout:
        {{ cfg.vuln_scan_timeout }}
      </div>
    }
  </div>
</div>
