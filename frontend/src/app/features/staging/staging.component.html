<!-- Portalcrane - Staging Component Template -->
<!-- Angular 21: @if / @for control flow, [value]/(input) signal bindings, no *ngIf / *ngFor -->
<div class="p-4">
  <!-- ── Page header ─────────────────────────────────────────────────────── -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h2 class="fw-bold mb-1">Staging Pipeline</h2>
      <p class="text-muted small mb-0">
        Search Docker Hub → Pull → CVE scan → Push to registry
      </p>
    </div>
  </div>

  <div class="row g-3">
    <!-- ── Left column: search + pull form ─────────────────────────────── -->
    <div class="col-lg-5">
      <!-- Search Docker Hub card -->
      <div class="card border-0 mb-3">
        <div class="card-header border-0">
          <h6 class="fw-semibold mb-0">
            <i class="bi bi-search me-2"></i>Search Docker Hub
          </h6>
        </div>
        <div class="card-body">
          <!-- Search input + button -->
          <div class="input-group mb-2">
            <input
              type="text"
              class="form-control"
              placeholder="nginx, redis, node…"
              [value]="searchQuery()"
              (input)="searchQuery.set($any($event.target).value)"
              (keyup.enter)="searchDockerHub()"
            />
            <button
              class="btn btn-primary"
              (click)="searchDockerHub()"
              [disabled]="searching()"
              type="button"
            >
              @if (searching()) {
                <span class="spinner-border spinner-border-sm"></span>
              } @else {
                <i class="bi bi-search"></i>
              }
            </button>
          </div>

          <!-- Search results list -->
          @if (searchResults().length > 0) {
            <div class="search-results-list">
              @for (result of searchResults(); track result.name) {
                <div
                  class="search-result-item p-2 rounded d-flex align-items-center justify-content-between gap-2"
                  [class.selected]="pullImage() === result.name"
                  (click)="selectImage(result.name)"
                  role="button"
                  tabindex="0"
                  (keyup.enter)="selectImage(result.name)"
                >
                  <!-- Left: name, badges, description, stats -->
                  <div class="overflow-hidden flex-grow-1">
                    <!-- Row 1: image name + official/automated badges -->
                    <div class="fw-semibold small text-truncate">
                      {{ result.name }}
                      @if (result.is_official) {
                        <span
                          class="badge bg-primary-subtle text-primary ms-1"
                          style="font-size: 0.65rem"
                          >Official</span
                        >
                      }
                      @if (result.is_automated) {
                        <span
                          class="badge bg-secondary-subtle text-secondary ms-1"
                          style="font-size: 0.65rem"
                          >Automated</span
                        >
                      }
                    </div>

                    <!-- Row 2: description -->
                    <div class="text-muted small text-truncate">
                      {{ result.description || "—" }}
                    </div>

                    <!-- Row 3: star count + download count -->
                    <div class="text-muted" style="font-size: 0.7rem">
                      <i class="bi bi-star me-1"></i
                      >{{ formatCount(result.star_count) }}
                      <span class="ms-2">
                        <i class="bi bi-download me-1"></i
                        >{{ formatCount(result.pull_count) }}
                      </span>
                    </div>
                  </div>

                  <!-- Right: select button — shows checkmark when already selected -->
                  <button
                    class="btn btn-sm flex-shrink-0"
                    [class.btn-primary]="pullImage() === result.name"
                    [class.btn-outline-primary]="pullImage() !== result.name"
                    (click)="selectImage(result.name); $event.stopPropagation()"
                    type="button"
                    title="Select {{ result.name }}"
                  >
                    @if (pullImage() === result.name) {
                      <i class="bi bi-check"></i>
                    } @else {
                      <i class="bi bi-plus"></i>
                    }
                  </button>
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Pull form card -->
      <div class="card border-0 mb-3">
        <div class="card-header border-0">
          <h6 class="fw-semibold mb-0">
            <i class="bi bi-cloud-download me-2"></i>Pull Image
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-2 align-items-end">
            <!-- Image name input -->
            <div class="col">
              <label class="form-label small fw-semibold">Image</label>
              <input
                type="text"
                class="form-control"
                placeholder="e.g. nginx, library/postgres"
                [value]="pullImage()"
                (input)="pullImage.set($any($event.target).value)"
              />
            </div>

            <!-- Tag selector or free-text input -->
            <div class="col-auto" style="min-width: 160px">
              <label class="form-label small fw-semibold">Tag</label>
              @if (availableTags().length > 0) {
                <select
                  class="form-select"
                  [value]="pullTag()"
                  (change)="pullTag.set($any($event.target).value)"
                >
                  @for (t of availableTags(); track t) {
                    <option [value]="t">{{ t }}</option>
                  }
                </select>
              } @else {
                <input
                  type="text"
                  class="form-control"
                  placeholder="latest"
                  [value]="pullTag()"
                  (input)="pullTag.set($any($event.target).value)"
                />
              }
            </div>

            <!-- Active scan config summary (read-only, driven by Settings) -->
            <div class="scan-summary d-flex gap-2 flex-wrap mb-3">
              <span
                class="badge"
                [class.bg-success-subtle]="configService.vulnEnabled()"
                [class.text-success]="configService.vulnEnabled()"
                [class.bg-secondary-subtle]="!configService.vulnEnabled()"
                [class.text-secondary]="!configService.vulnEnabled()"
              >
                <i class="bi bi-bug me-1"></i>
                Trivy {{ configService.vulnEnabled() ? "ON" : "OFF" }}
                @if (configService.vulnEnabled()) {
                  <span class="ms-1 opacity-75"
                    >({{ configService.vulnSeveritiesString() }})</span
                  >
                }
              </span>
              <a
                routerLink="/settings"
                class="badge bg-body-secondary text-muted text-decoration-none"
                title="Configure scans in Settings"
              >
                <i class="bi bi-gear me-1"></i>Configure
              </a>
            </div>

            <!-- Pull button -->
            <div class="col-auto">
              <button
                class="btn btn-primary"
                (click)="startPull()"
                [disabled]="pulling() || !pullImage()"
                type="button"
              >
                @if (pulling()) {
                  <span class="spinner-border spinner-border-sm me-1"></span>
                  Pulling…
                } @else {
                  <i class="bi bi-cloud-download me-1"></i>Pull
                }
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ── End left column ──────────────────────────────────────────────── -->

    <!-- ── Right column: job list ───────────────────────────────────────── -->
    <div class="col-lg-7">
      <div class="card border-0">
        <div
          class="card-header border-0 d-flex align-items-center justify-content-between"
        >
          <h6 class="fw-semibold mb-0">
            <i class="bi bi-list-task me-2"></i>Pipeline Jobs
          </h6>
          <span class="badge bg-secondary-subtle text-secondary">
            {{ jobs().length }}
          </span>
        </div>
        <div class="card-body p-0">
          @if (jobs().length === 0) {
            <div class="text-center py-5 text-muted">
              <i
                class="bi bi-cloud-download display-4 d-block mb-3 opacity-25"
              ></i>
              No staging jobs yet. Search and pull an image to get started.
            </div>
          } @else {
            <div class="job-list">
              @for (job of jobs(); track job.job_id) {
                <div class="job-card m-3 p-3 rounded">
                  <!-- Job header row -->
                  <div class="d-flex align-items-start gap-2 mb-2">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span class="fw-semibold font-monospace small">
                          {{ job.image }}:{{ job.tag }}
                        </span>
                      </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span [class]="getStatusBadgeClass(job.status)">{{
                        job.status
                      }}</span>
                      <button
                        class="btn btn-sm btn-outline-danger border-0 p-0 px-1"
                        (click)="deleteJob(job.job_id)"
                      >
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Scan badges applied on this job (advanced mode only) -->
                  <div class="d-flex gap-1 mb-2 flex-wrap">
                    @if (job.vuln_scan_enabled_override !== null) {
                      <span
                        class="badge"
                        [class.bg-success-subtle]="
                          job.vuln_scan_enabled_override
                        "
                        [class.text-success]="job.vuln_scan_enabled_override"
                        [class.bg-secondary-subtle]="
                          !job.vuln_scan_enabled_override
                        "
                        [class.text-secondary]="!job.vuln_scan_enabled_override"
                        style="font-size: 0.65rem"
                      >
                        <i class="bi bi-bug me-1"></i>Trivy
                        {{ job.vuln_scan_enabled_override ? "ON" : "OFF" }}
                        @if (
                          job.vuln_scan_enabled_override &&
                          job.vuln_severities_override
                        ) {
                          ({{ job.vuln_severities_override }})
                        }
                      </span>
                    }
                  </div>

                  <!-- Progress bar -->
                  <div class="progress mb-2" style="height: 4px">
                    <div
                      class="progress-bar"
                      [class.bg-danger]="
                        ['scan_vulnerable', 'scan_infected', 'failed'].includes(
                          job.status
                        )
                      "
                      [class.bg-success]="
                        ['scan_clean', 'scan_skipped', 'done'].includes(
                          job.status
                        )
                      "
                      [class.progress-bar-striped]="
                        [
                          'pending',
                          'pulling',
                          'scanning',
                          'vuln_scanning',
                          'pushing',
                        ].includes(job.status)
                      "
                      [class.progress-bar-animated]="
                        [
                          'pending',
                          'pulling',
                          'scanning',
                          'vuln_scanning',
                          'pushing',
                        ].includes(job.status)
                      "
                      [style.width.%]="displayProgress(job)"
                    ></div>
                  </div>

                  @if (job.message) {
                    <div class="small text-muted">{{ job.message }}</div>
                  }

                  <!-- CVE summary (when scan found vulnerabilities) -->
                  @if (job.vuln_result && job.vuln_result.counts) {
                    <div class="d-flex gap-1 flex-wrap mb-2">
                      @for (
                        sev of ["CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"];
                        track sev
                      ) {
                        @if (
                          getVulnCount(job, sev) > 0 ||
                          job.vuln_result.severities.includes(sev)
                        ) {
                          <span
                            class="badge"
                            [class.bg-danger]="
                              sev === 'CRITICAL' && getVulnCount(job, sev) > 0
                            "
                            [class.text-white]="
                              sev === 'CRITICAL' && getVulnCount(job, sev) > 0
                            "
                            [class.bg-danger-subtle]="
                              sev === 'CRITICAL' && getVulnCount(job, sev) === 0
                            "
                            [class.text-danger]="
                              sev === 'CRITICAL' && getVulnCount(job, sev) === 0
                            "
                            [class.bg-warning]="
                              sev === 'HIGH' && getVulnCount(job, sev) > 0
                            "
                            [class.bg-warning-subtle]="
                              sev === 'HIGH' && getVulnCount(job, sev) === 0
                            "
                            [class.text-warning]="
                              sev === 'HIGH' && getVulnCount(job, sev) === 0
                            "
                            [class.bg-success-subtle]="
                              ['MEDIUM', 'LOW', 'UNKNOWN'].includes(sev) &&
                              getVulnCount(job, sev) === 0
                            "
                            [class.text-success]="
                              ['MEDIUM', 'LOW', 'UNKNOWN'].includes(sev) &&
                              getVulnCount(job, sev) === 0
                            "
                            [class.bg-secondary-subtle]="
                              ['MEDIUM', 'LOW', 'UNKNOWN'].includes(sev) &&
                              getVulnCount(job, sev) > 0
                            "
                            [class.text-secondary]="
                              ['MEDIUM', 'LOW', 'UNKNOWN'].includes(sev) &&
                              getVulnCount(job, sev) > 0
                            "
                            style="font-size: 0.65rem"
                            [title]="
                              sev +
                              ': ' +
                              getVulnCount(job, sev) +
                              ' CVE(s) found'
                            "
                          >
                            {{ sev[0] }}: {{ getVulnCount(job, sev) }}
                          </span>
                        }
                      }
                    </div>
                  }

                  <!-- ── Push panel ──────────────────────────────────────── -->
                  <!-- Visible for: scan_clean, scan_skipped (ready to push)  -->
                  <!--              done (push completed — show summary)       -->
                  @if (
                    ["scan_clean", "scan_skipped", "done"].includes(job.status)
                  ) {
                    <div class="mt-2 pt-2 border-top">
                      @if (job.status === "done") {
                        <!-- ── Push completed summary ─────────────────────── -->
                        <div
                          class="d-flex align-items-center justify-content-between gap-2"
                        >
                          <div class="text-success small">
                            <i class="bi bi-check-circle-fill me-1"></i>
                            Pushed as
                            <code class="text-success"
                              >{{ job.target_image }}:{{ job.target_tag }}</code
                            >
                          </div>
                          <!-- Re-push button: resets job status client-side to scan_clean -->
                          <button
                            class="btn btn-sm btn-outline-secondary text-nowrap"
                            (click)="allowRePush(job)"
                            type="button"
                            title="Push again to a different destination"
                          >
                            <i class="bi bi-arrow-repeat me-1"></i>Re-push
                          </button>
                        </div>
                      } @else {
                        <!-- ── Push form (scan_clean / scan_skipped) ──────── -->

                        <!-- Destination toggle -->
                        <div class="d-flex gap-2 mb-2">
                          <button
                            class="btn btn-sm flex-fill"
                            [class.btn-primary]="getPushMode(job) === 'local'"
                            [class.btn-outline-secondary]="
                              getPushMode(job) !== 'local'
                            "
                            (click)="setPushMode(job, 'local')"
                            type="button"
                          >
                            <i class="bi bi-hdd-network me-1"></i>Local
                          </button>
                          <button
                            class="btn btn-sm flex-fill"
                            [class.btn-primary]="
                              getPushMode(job) === 'external'
                            "
                            [class.btn-outline-secondary]="
                              getPushMode(job) !== 'external'
                            "
                            (click)="setPushMode(job, 'external')"
                            type="button"
                          >
                            <i class="bi bi-globe me-1"></i>External
                          </button>
                        </div>

                        <!-- External registry fields -->
                        @if (getPushMode(job) === "external") {
                          <div
                            class="mb-2 p-2 rounded border border-primary-subtle bg-primary-subtle bg-opacity-10"
                          >
                            <!-- Saved registry selector -->
                            @if (externalRegistries().length > 0) {
                              <div class="mb-2">
                                <label class="form-label small fw-semibold"
                                  >Saved registry</label
                                >
                                <select
                                  class="form-select form-select-sm"
                                  [value]="getExtRegistryId(job)"
                                  (change)="
                                    setExtRegistryId(
                                      job,
                                      $any($event.target).value
                                    )
                                  "
                                >
                                  <option value="">— Enter manually —</option>
                                  @for (
                                    reg of externalRegistries();
                                    track reg.id
                                  ) {
                                    <option [value]="reg.id">
                                      {{ reg.name }} ({{ reg.host }})
                                    </option>
                                  }
                                </select>
                              </div>
                            }

                            <!-- Ad-hoc fields shown when no saved registry is selected -->
                            @if (!getExtRegistryId(job)) {
                              <div class="row g-2">
                                <div class="col-12">
                                  <input
                                    type="text"
                                    class="form-control form-control-sm"
                                    placeholder="Registry host (e.g. registry.mycompany.com)"
                                    [value]="getPushTarget(job, 'ext_host')"
                                    (input)="
                                      updatePushTarget(
                                        job,
                                        'ext_host',
                                        $any($event.target).value
                                      )
                                    "
                                  />
                                </div>
                                <div class="col-6">
                                  <input
                                    type="text"
                                    class="form-control form-control-sm"
                                    placeholder="Username (optional)"
                                    [value]="getPushTarget(job, 'ext_user')"
                                    (input)="
                                      updatePushTarget(
                                        job,
                                        'ext_user',
                                        $any($event.target).value
                                      )
                                    "
                                  />
                                </div>
                                <div class="col-6">
                                  <input
                                    type="password"
                                    class="form-control form-control-sm"
                                    placeholder="Password (optional)"
                                    [value]="getPushTarget(job, 'ext_pass')"
                                    (input)="
                                      updatePushTarget(
                                        job,
                                        'ext_pass',
                                        $any($event.target).value
                                      )
                                    "
                                  />
                                </div>
                              </div>
                            }
                          </div>
                        }

                        <!-- Folder / image name / tag fields -->
                        <div class="row g-2 mb-2 align-items-end">
                          <div class="col">
                            <label
                              class="form-label small text-muted"
                              style="font-size: 0.7rem"
                            >
                              Folder <span class="opacity-50">(optional)</span>
                            </label>
                            <input
                              type="text"
                              class="form-control form-control-sm font-monospace"
                              placeholder="e.g. infra"
                              [value]="getPushTarget(job, 'folder')"
                              (input)="
                                updatePushTarget(
                                  job,
                                  'folder',
                                  $any($event.target).value
                                )
                              "
                            />
                          </div>
                          <div class="col">
                            <label
                              class="form-label small text-muted"
                              style="font-size: 0.7rem"
                              >Image name</label
                            >
                            <input
                              type="text"
                              class="form-control form-control-sm font-monospace"
                              [placeholder]="job.image"
                              [value]="getPushTarget(job, 'img')"
                              (input)="
                                updatePushTarget(
                                  job,
                                  'img',
                                  $any($event.target).value
                                )
                              "
                            />
                          </div>
                          <div class="col-auto" style="min-width: 90px">
                            <label
                              class="form-label small text-muted"
                              style="font-size: 0.7rem"
                              >Tag</label
                            >
                            <input
                              type="text"
                              class="form-control form-control-sm font-monospace"
                              [placeholder]="job.tag"
                              [value]="getPushTarget(job, 'tag')"
                              (input)="
                                updatePushTarget(
                                  job,
                                  'tag',
                                  $any($event.target).value
                                )
                              "
                            />
                          </div>
                        </div>

                        <!-- Preview + push button -->
                        <div
                          class="d-flex align-items-center justify-content-between gap-2"
                        >
                          <code class="small text-muted text-truncate">{{
                            pushPreview(job)
                          }}</code>
                          <button
                            class="btn btn-sm btn-success text-nowrap"
                            (click)="pushImage(job)"
                            [disabled]="pushing() === job.job_id"
                            type="button"
                          >
                            @if (pushing() === job.job_id) {
                              <span
                                class="spinner-border spinner-border-sm me-1"
                              ></span>
                            } @else {
                              <i class="bi bi-upload me-1"></i>
                            }
                            Push
                          </button>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
    <!-- ── End right column ─────────────────────────────────────────────── -->
  </div>
</div>
