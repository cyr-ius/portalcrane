<!-- Portalcrane - Images List Template (flat + folder tree view) -->
<div class="p-4">
  <!-- ── Page header ─────────────────────────────────────────────────────── -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h2 class="fw-bold mb-1">Images</h2>
      <p class="text-muted small mb-0">
        Browse and manage your registry images
      </p>
    </div>
  </div>

  <!-- ── Toolbar ─────────────────────────────────────────────────────────── -->
  <div class="card border-0 mb-3">
    <div class="card-body py-2">
      <div class="row g-2 align-items-center">
        <!-- Text search -->
        <div class="col">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input
              type="text"
              class="form-control"
              placeholder="Search images…"
              [(ngModel)]="searchQuery"
              (ngModelChange)="onSearch()"
            />
            @if (searchQuery) {
              <button class="btn btn-outline-secondary" (click)="clearSearch()">
                <i class="bi bi-x-lg"></i>
              </button>
            }
          </div>
        </div>

        <!-- Tag count filter chips -->
        <div class="col-auto d-flex gap-1">
          <button
            class="btn btn-sm"
            [class.btn-primary]="tagFilter() === 'all'"
            [class.btn-outline-secondary]="tagFilter() !== 'all'"
            (click)="setTagFilter('all')"
          >
            All
          </button>
          <button
            class="btn btn-sm"
            [class.btn-warning]="tagFilter() === 'single'"
            [class.btn-outline-secondary]="tagFilter() !== 'single'"
            (click)="setTagFilter('single')"
          >
            <i class="bi bi-tag me-1"></i>Single tag
          </button>
          <button
            class="btn btn-sm"
            [class.btn-primary]="tagFilter() === 'multi'"
            [class.btn-outline-secondary]="tagFilter() !== 'multi'"
            (click)="setTagFilter('multi')"
          >
            <i class="bi bi-tags me-1"></i>Multi-tag
          </button>
        </div>

        <!-- View mode toggle -->
        <div class="col-auto">
          <div class="btn-group btn-group-sm">
            <button
              class="btn"
              [class.btn-secondary]="viewMode() === 'flat'"
              [class.btn-outline-secondary]="viewMode() !== 'flat'"
              (click)="setViewMode('flat')"
              title="List view"
            >
              <i class="bi bi-list-ul me-1"></i>List
            </button>
            <button
              class="btn"
              [class.btn-secondary]="viewMode() === 'tree'"
              [class.btn-outline-secondary]="viewMode() !== 'tree'"
              (click)="setViewMode('tree')"
              title="Folder view"
            >
              <i class="bi bi-folder2-open me-1"></i>Folders
            </button>
          </div>
        </div>

        <!-- Page size -->
        <div class="col-auto">
          <select
            class="form-select form-select-sm"
            [(ngModel)]="pageSize"
            (ngModelChange)="onPageSizeChange()"
          >
            <option [value]="10">10 / page</option>
            <option [value]="20">20 / page</option>
            <option [value]="50">50 / page</option>
            <option [value]="100">100 / page</option>
          </select>
        </div>

        <!-- Refresh -->
        <div class="col-auto">
          <button
            class="btn btn-sm btn-outline-secondary"
            (click)="loadImages()"
            title="Refresh"
          >
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>

      <!-- Active filter summary -->
      @if (tagFilter() !== "all") {
        <div class="mt-2 d-flex align-items-center gap-2">
          <span class="text-muted small">
            <i class="bi bi-funnel me-1"></i>
            Showing <strong>{{ filteredItems().length }}</strong> of
            {{ data()?.items?.length ?? 0 }}
          </span>
          <button
            class="btn btn-link btn-sm p-0 text-muted"
            (click)="setTagFilter('all')"
          >
            Clear filter
          </button>
        </div>
      }
    </div>
  </div>

  <!-- ── Content ──────────────────────────────────────────────────────────── -->
  <div class="card border-0">
    @if (loading()) {
      <div class="d-flex justify-content-center py-5">
        <div class="spinner-border text-primary"></div>
      </div>
    } @else if (viewMode() === "flat") {
      <!-- ═══════════════════════════════════════════ FLAT LIST ══════════════ -->
      @if (filteredItems().length === 0) {
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox display-4 d-block mb-3"></i>
          @if (tagFilter() !== "all") {
            No images match the current filter
          } @else {
            No images found in the registry
          }
        </div>
      } @else {
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th class="border-0 text-muted fw-semibold small">
                  <button
                    class="btn btn-link btn-sm p-0 text-muted fw-semibold text-decoration-none d-flex align-items-center gap-1"
                    (click)="toggleSort('name')"
                  >
                    REPOSITORY <i [class]="'bi ' + sortIcon('name')"></i>
                  </button>
                </th>
                <th class="border-0 text-muted fw-semibold small">
                  <button
                    class="btn btn-link btn-sm p-0 text-muted fw-semibold text-decoration-none d-flex align-items-center gap-1"
                    (click)="toggleSort('tag_count')"
                  >
                    TAGS <i [class]="'bi ' + sortIconNumeric('tag_count')"></i>
                  </button>
                </th>
                <th class="border-0 text-muted fw-semibold small">TAG LIST</th>
                <th class="border-0 text-muted fw-semibold small text-end">
                  ACTIONS
                </th>
              </tr>
            </thead>
            <tbody>
              @for (image of filteredItems(); track image.name) {
                <tr>
                  <td class="align-middle">
                    <div class="d-flex align-items-center gap-2">
                      <div class="image-icon">
                        <i class="bi bi-box-seam"></i>
                      </div>
                      <a
                        [routerLink]="['/images', image.name]"
                        class="fw-semibold text-decoration-none link-body-emphasis font-monospace small"
                        >{{ image.name }}</a
                      >
                    </div>
                  </td>
                  <td class="align-middle">
                    <span
                      [class]="
                        image.tag_count === 1
                          ? 'badge bg-warning-subtle text-warning'
                          : 'badge bg-primary-subtle text-primary'
                      "
                      >{{ image.tag_count }}</span
                    >
                  </td>
                  <td class="align-middle">
                    <div class="d-flex flex-wrap gap-1">
                      @for (tag of image.tags.slice(0, 4); track tag) {
                        <span
                          [class]="
                            tag === 'latest'
                              ? 'badge bg-success-subtle text-success font-monospace'
                              : 'badge bg-secondary-subtle text-secondary font-monospace'
                          "
                          >{{ tag === "latest" ? "★ " + tag : tag }}</span
                        >
                      }
                      @if (image.tags.length > 4) {
                        <span class="badge bg-secondary-subtle text-muted"
                          >+{{ image.tags.length - 4 }} more</span
                        >
                      }
                    </div>
                  </td>
                  <td class="align-middle text-end">
                    <div class="d-flex gap-1 justify-content-end">
                      <a
                        [routerLink]="['/images', image.name]"
                        class="btn btn-sm btn-outline-primary"
                        title="View details"
                      >
                        <i class="bi bi-eye"></i>
                      </a>
                      <button
                        class="btn btn-sm btn-outline-danger"
                        (click)="confirmDeleteImage(image)"
                        [title]="'Delete ' + image.name"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div
          class="card-footer border-0 d-flex align-items-center justify-content-between py-2"
        >
          <span class="text-muted small">
            Showing {{ pageStart() }}–{{ pageEnd() }} of
            {{ data()?.total }} images
          </span>
          <nav>
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" [class.disabled]="currentPage() === 1">
                <button class="page-link" (click)="goToPage(currentPage() - 1)">
                  <i class="bi bi-chevron-left"></i>
                </button>
              </li>
              @for (p of pages(); track p) {
                <li class="page-item" [class.active]="p === currentPage()">
                  <button class="page-link" (click)="goToPage(p)">
                    {{ p }}
                  </button>
                </li>
              }
              <li
                class="page-item"
                [class.disabled]="currentPage() === data()?.total_pages"
              >
                <button class="page-link" (click)="goToPage(currentPage() + 1)">
                  <i class="bi bi-chevron-right"></i>
                </button>
              </li>
            </ul>
          </nav>
        </div>
      }
    } @else {
      <!-- ══════════════════════════════════════════ FOLDER TREE ═════════════ -->
      @if (folderTree().length === 0) {
        <div class="text-center py-5 text-muted">
          <i class="bi bi-inbox display-4 d-block mb-3"></i>
          No images found in the registry
        </div>
      } @else {
        <div class="tree-view">
          @for (folder of folderTree(); track folder.name) {
            <!-- Folder row -->
            <div
              class="folder-row d-flex align-items-center gap-2 px-3 py-2 border-bottom bg-body-tertiary"
              (click)="toggleFolder(folder.name)"
              style="cursor: pointer; user-select: none"
            >
              <i
                class="bi bi-chevron-right text-muted transition-transform"
                [style.transform]="
                  isFolderExpanded(folder.name) ? 'rotate(90deg)' : 'rotate(0)'
                "
                style="font-size: 0.75rem; transition: transform 0.15s"
              ></i>
              <i
                class="bi text-warning"
                [class.bi-folder2-open]="isFolderExpanded(folder.name)"
                [class.bi-folder2]="!isFolderExpanded(folder.name)"
              ></i>
              <span class="fw-semibold small font-monospace text-body">
                {{ folder.name === "(root)" ? "/ (root)" : folder.name }}
              </span>
              <span class="badge bg-secondary-subtle text-secondary ms-auto">
                {{ folder.images.length }} image{{
                  folder.images.length !== 1 ? "s" : ""
                }}
              </span>
            </div>

            <!-- Image rows inside folder -->
            @if (isFolderExpanded(folder.name)) {
              @for (image of folder.images; track image.name) {
                <div
                  class="image-row d-flex align-items-center justify-content-between px-3 py-2 border-bottom border-start border-3 ms-4"
                  style="border-color: transparent !important"
                  [style.borderLeftColor]="
                    'var(--bs-primary-border-subtle) !important'
                  "
                >
                  <div class="d-flex align-items-center gap-2">
                    <div class="image-icon image-icon-sm">
                      <i class="bi bi-box-seam"></i>
                    </div>
                    <div>
                      <a
                        [routerLink]="['/images', image.name]"
                        class="fw-semibold text-decoration-none link-body-emphasis font-monospace small"
                        >{{ imageShortName(image) }}</a
                      >
                      <div class="d-flex flex-wrap gap-1 mt-1">
                        @for (tag of image.tags.slice(0, 5); track tag) {
                          <span
                            [class]="
                              tag === 'latest'
                                ? 'badge bg-success-subtle text-success font-monospace'
                                : 'badge bg-secondary-subtle text-secondary font-monospace'
                            "
                            style="font-size: 0.65rem"
                            >{{ tag === "latest" ? "★ " + tag : tag }}</span
                          >
                        }
                        @if (image.tags.length > 5) {
                          <span
                            class="badge bg-secondary-subtle text-muted"
                            style="font-size: 0.65rem"
                          >
                            +{{ image.tags.length - 5 }} more
                          </span>
                        }
                      </div>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-primary-subtle text-primary">{{
                      image.tag_count
                    }}</span>
                    <a
                      [routerLink]="['/images', image.name]"
                      class="btn btn-sm btn-outline-primary"
                      title="View details"
                    >
                      <i class="bi bi-eye"></i>
                    </a>
                    <button
                      class="btn btn-sm btn-outline-danger"
                      (click)="confirmDeleteImage(image)"
                      [title]="'Delete ' + image.name"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              }
            }
          }
        </div>
      }
    }
  </div>
</div>

<!-- ── Delete confirmation modal ─────────────────────────────────────────── -->
@if (deleteTarget()) {
  <div
    class="modal d-block"
    tabindex="-1"
    style="background: rgba(0, 0, 0, 0.5)"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold text-danger">
            <i class="bi bi-trash me-2"></i>Delete image
          </h5>
          <button
            type="button"
            class="btn-close"
            (click)="deleteTarget.set(null)"
          ></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete all tags of:</p>
          <code class="text-danger">{{ deleteTarget()!.name }}</code>
          <p class="mt-2 text-muted small">This action cannot be undone.</p>
        </div>
        <div class="modal-footer border-0">
          <button
            class="btn btn-outline-secondary"
            (click)="deleteTarget.set(null)"
          >
            Cancel
          </button>
          <button
            class="btn btn-danger"
            (click)="deleteImage()"
            [disabled]="deleting()"
          >
            @if (deleting()) {
              <span class="spinner-border spinner-border-sm me-2"></span
              >Deleting…
            } @else {
              <i class="bi bi-trash me-1"></i>Delete
            }
          </button>
        </div>
      </div>
    </div>
  </div>
}
